#!/usr/bin/env bash

# If not running interactively, don't do anything
if [[ "$-" != *i* ]]; then
    return
fi

# Load tmux if not loaded
if command -v tmux > /dev/null; then
    if [[ -z "$TMUX" ]]; then
        ID="$(tmux ls 2> /dev/null | grep -vm1 attached | cut -d: -f1)" # get the id of a deattached session
        if [[ -z "$ID" ]]; then
            tmux new-session
        else
            tmux attach-session -t "$ID"
        fi
    fi
fi

export DOTFILES="$HOME/.dotfiles"
export DOTFILES_PRIVATE="$HOME/.dotfiles-private"

source "$DOTFILES/bash/base-colors.bash"
source "$DOTFILES/bash/base-functions.bash"
source "$DOTFILES/bash/base-symbols.bash"

SetOsEnvironmentVariables
SetVirtualizationEnvironmentVariables

# We want to walk "outside" in... which is to say run all options files first, then all
# exports, then all functions, etc.
for folder in "options" "exports" "functions" "third-party" "other" "aliases"; do
    for base in "shared" "$OS_PRIMARY" "distros/$OS_SECONDARY"; do
        for root in "$DOTFILES/bash" "$DOTFILES_PRIVATE/bash"; do
            if [[ -d "$root/$base/$folder" ]]; then
                for file in $root/$base/$folder/*.bash; do
                    source "$file"
                done
            fi
        done
    done
done

# On Windows shells runnin in WSL run some overrides
if [[ $IS_WSL == "true" ]]; then
    for folder in "options" "exports" "functions" "third-party" "other" "aliases"; do
        for root in "$DOTFILES/bash" "$DOTFILES_PRIVATE/bash"; do
            if [[ -d "$root/windows-wsl/$folder" ]]; then
                for file in $root/windows-wsl/$folder/*.bash; do
                    source "$file"
                done
            fi
        done
    done
fi

# Local config, this should be last and never checked into source control (or if it is it should be host specific)
source_if "$HOME/.bashrc.local"

unset root
unset base
unset folder
unset file

