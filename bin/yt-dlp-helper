#!/usr/bin/env bash

# Bash strict mode
# shellcheck disable=SC2154
([[ -n ${ZSH_EVAL_CONTEXT} && ${ZSH_EVAL_CONTEXT} =~ :file$ ]] ||
  [[ -n ${BASH_VERSION} ]] && (return 0 2>/dev/null)) && SOURCED=true || SOURCED=false
if ! ${SOURCED}; then
  set -o errexit  # same as set -e
  set -o nounset  # same as set -u
  set -o errtrace # same as set -E
  set -o pipefail
  set -o posix
  #set -o xtrace # same as set -x, turn on for debugging

  shopt -s extdebug
  IFS=$(printf '\n\t')
fi
# END Bash scrict mode

# SCRIPT_NAME=$(basename "$0")
# SCRIPT_AUTHOR="Brennan Fee"
# SCRIPT_LICENSE="MIT License"
# SCRIPT_VERSION="0.1"
# SCRIPT_DATE="2024-08-27"

source "$(dirname "$0")/../bash/script-tools.bash"

function yt_helper() {
  local url
  if is_wsl; then
    url=$(powershell.exe -NoProfile -NonInteractive -ExecutionPolicy Bypass -Command Get-Clipboard)
  else
    url=$(xsel -o --clipboard)
  fi

  # Format
  local highFormat
  highFormat+="bestvideo[height<=?1080][vcodec~='^((he|a)vc1?|h26[45])']+bestaudio"
  highFormat+="/best[height<=?1080][vcodec~='^((he|a)vc1?|h26[45])']"
  highFormat+="/best[height<=?1080]"

  local lowFormat
  lowFormat+="bestvideo[height<=?720][vcodec~='^((he|a)vc1?|h26[45])']+bestaudio"
  lowFormat+="/best[height<=?720][vcodec~='^((he|a)vc1?|h26[45])']"
  lowFormat+="/best[height<=?720]"

  local format="${highFormat}"

  if [[ "$1" == "low" ]]; then
    format="${lowFormat}"
  fi

  # Playlist flag
  local playlist="--no-playlist"
  if [[ "${3:-}" == "yes" ]]; then
    playlist="--yes-playlist"
  fi

  # Sort Order
  local sort_order="ext:mp4:m4a,proto"

  # Output file name
  local output="${4}/%(title).125B-%(id)s-[%(channel,channel_id,creator,uploader)s].%(ext)s"

  echo "Downloading ${url}"
  yt-dlp --cookies-from-browser "$2" --embed-metadata --mark-watched --embed-thumbnail \
    "${playlist}" --no-mtime -i -S "${sort_order}" -f "${format}" -o "${output}" \
    "${url}" "${@:5}"
}

function yt() {
  local directory
  directory="$(xdg-user-dir VIDEOS)"
  mkdir -p "${directory}"
  yt_helper "high" "firefox" "no" "${directory}" "$@"
}

function yt_playlist() {
  local directory
  directory="$(xdg-user-dir VIDEOS)"
  mkdir -p "${directory}"
  yt_helper "high" "firefox" "yes" "${directory}" "$@"
}

function pt() {
  local directory
  directory="$(xdg-user-dir PICTURES)/_other"
  mkdir -p "${directory}"
  yt_helper "low" "chrome" "no" "${directory}" "$@"
}

function pt_playlist() {
  local directory
  directory="$(xdg-user-dir PICTURES)/_other"
  mkdir -p "${directory}"
  yt_helper "low" "chrome" "yes" "${directory}" "$@"
}

# To extract an MP3 from a video, requires ffmpeg to be installed
function ytm() {
  local output
  output="$(xdg-user-dir VIDEOS)/%(title).125B-%(id)s-youtube.%(ext)s"

  local url
  if is_wsl; then
    url=$(powershell.exe -NoProfile -NonInteractive -ExecutionPolicy Bypass -Command Get-Clipboard)
  else
    url=$(xsel -o --clipboard)
  fi

  echo "Downloading ${url}"
  yt-dlp --cookies-from-browser firefox --embed-metadata --embed-thumbnail --no-mtime \
    --no-playlist --extract-audio --audio-format mp3 -i -o "${output}" "${url}" "${@:2}"
}

function main() {
  local sub_command
  sub_command="${1:-}"
  shift

  case "${sub_command}" in
  yt)
    yt "$@"
    ;;
  ytlist)
    yt_playlist "$@"
    ;;
  pt)
    pt "$@"
    ;;
  ptlist)
    pt_playlist "$@"
    ;;
  ytm)
    ytm "$@"
    ;;
  *)
    throw_error_msg "Unknown yt-dlp-helper command: '${1:-}'"
    ;;
  esac
}

main "$@"
