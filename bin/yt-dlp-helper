#!/usr/bin/env bash

# Bash strict mode
# shellcheck disable=SC2154
([[ -n ${ZSH_EVAL_CONTEXT} && ${ZSH_EVAL_CONTEXT} =~ :file$ ]] ||
  [[ -n ${BASH_VERSION} ]] && (return 0 2>/dev/null)) && SOURCED=true || SOURCED=false
if ! ${SOURCED}; then
  set -o errexit  # same as set -e
  set -o nounset  # same as set -u
  set -o errtrace # same as set -E
  set -o pipefail
  set -o posix
  #set -o xtrace # same as set -x, turn on for debugging

  shopt -s extdebug
  IFS=$(printf '\n\t')
fi
# END Bash scrict mode

# SCRIPT_NAME=$(basename "$0")
# SCRIPT_AUTHOR="Brennan Fee"
# SCRIPT_LICENSE="MIT License"
# SCRIPT_VERSION="0.1"
# SCRIPT_DATE="2024-08-27"

source "$(dirname "$0")/../bash/script-tools.bash"

function yt_helper() {
  local url
  if is_wsl; then
    url=$(powershell.exe -NoProfile -NonInteractive -ExecutionPolicy Bypass -Command Get-Clipboard)
  else
    url=$(xsel -o --clipboard)
  fi

  local highFormat="bestvideo[height<=?1080]+bestaudio/best[height<=?1080]/best"
  local lowFormat="bestvideo[height<=?720]+bestaudio/best[height<=?720]/best"
  local format="${highFormat}"

  if [[ "$1" == "low" ]]; then
    format="${lowFormat}"
  fi

  prog="youtube-dl"
  if command -v "yt-dlp" &>/dev/null; then
    prog="yt-dlp"
  fi

  echo "Downloading ${url}"
  ${prog} --cookies-from-browser "$2" --embed-metadata --mark-watched --embed-thumbnail --no-mtime -i -S +codec:avc:m4a -f "${format}" -o "$3" "${url}" "${@:4}"
}

function yt() {
  local output
  output="$(xdg-user-dir VIDEOS)/%(title).125B-%(id)s-[%(channel,channel_id,creator,uploader)s].%(ext)s"
  yt_helper "high" "firefox" "${output}" "$@"
}

function pt() {
  local folder
  local output
  folder="$(xdg-user-dir PICTURES)/_other"
  mkdir -p "${folder}"
  output="${folder}/%(title).125B-%(id)s-[%(channel,channel_id,creator,uploader)s].%(ext)s"
  yt_helper "low" "chrome" "${output}" "$@"
}

# To extract an MP3 from a video, requires ffmpeg to be installed
function ytm() {
  local output
  output="$(xdg-user-dir VIDEOS)/%(title).125B-%(id)s-youtube.%(ext)s"

  local url
  if is_wsl; then
    url=$(powershell.exe -NoProfile -NonInteractive -ExecutionPolicy Bypass -Command Get-Clipboard)
  else
    url=$(xsel -o --clipboard)
  fi

  prog="youtube-dl"
  if command -v "yt-dlp" &>/dev/null; then
    prog="yt-dlp"
  fi

  echo "Downloading ${url}"
  ${prog} --cookies-from-browser firefox --embed-metadata --embed-thumbnail --no-mtime --extract-audio --audio-format mp3 -i -o "${output}" "${url}" "${@:2}"
}

function main() {
  local sub_command
  sub_command="${1:-}"
  shift

  case "${sub_command}" in
  yt)
    yt "$@"
    ;;
  pt)
    pt "$@"
    ;;
  ytm)
    ytm "$@"
    ;;
  *)
    throw_error_msg "Unknown yt-dlp-helper command: '${1:-}'"
    ;;
  esac
}

main "$@"
