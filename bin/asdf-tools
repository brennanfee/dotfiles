#!/usr/bin/env bash

# Bash strict mode
([[ -n ${ZSH_EVAL_CONTEXT:-} && ${ZSH_EVAL_CONTEXT:-} =~ :file$ ]] ||
  [[ -n ${BASH_VERSION:-} ]] && (return 0 2>/dev/null)) && SOURCED=true || SOURCED=false
if ! ${SOURCED}; then
  set -o errexit  # same as set -e
  set -o nounset  # same as set -u
  set -o errtrace # same as set -E
  set -o pipefail
  set -o posix
  #set -o xtrace # same as set -x, turn on for debugging

  shopt -s inherit_errexit
  shopt -s extdebug
  IFS=$(printf '\n\t')
fi
# END Bash strict mode

# TODO: Split some off into a "dev" only installer with a command-line option to install those as well

### START Utility functions

# Text modifiers
TEXT_RESET="$(tput sgr0)"
TEXT_YELLOW="$(tput setaf 3)"

print_warning() {
  local T_COLS
  T_COLS=$(tput cols)
  T_COLS=$((T_COLS - 1))
  echo -e "${TEXT_YELLOW}$1${TEXT_RESET}" | fold -sw "${T_COLS}"
}

### END Utility functions

if ! command -v asdf &>/dev/null; then
  git clone https://github.com/asdf-vm/asdf.git "${XDG_DATA_HOME}/asdf" --branch v0.9.0

  msg="The 'asdf' utility was installed.  You will need to close and re-open the terminal."
  msg="${msg} Re-run this script again after re-opening the terminal to install asdf tools."

  print_warning "${msg}"
  exit 0
fi

add_if_needed() {
  local installed
  installed=$(asdf plugin list | grep -i -c "${1}")
  if [[ "${installed}" != 1 ]]; then
    asdf plugin add "${1}"
  fi
}

# Update asdf itself
asdf update

# Install the plugins, if needed
add_if_needed dotnet
add_if_needed golang
add_if_needed java
add_if_needed kotlin
add_if_needed nodejs
add_if_needed packer
add_if_needed python
add_if_needed ruby
add_if_needed rust
add_if_needed semver
add_if_needed terraform

# Now update all plugins
asdf plugin update --all

# Now install the tools
asdf install
